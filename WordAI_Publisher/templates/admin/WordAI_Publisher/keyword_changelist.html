{% extends "admin/change_list.html" %}

{% block object-tools-items %}
  <li><a href="upload-csv/" class="addlink">Upload CSV</a></li>
  {{ block.super }}
{% endblock %}

{% block extrahead %}
  {{ block.super }}
  <style>
    /* ---------- Selection modals (single + bulk) ---------- */
    #generateContentModal, #bulkGenerateModal {
      display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh;
      background:rgba(0,0,0,.4); align-items:center; justify-content:center;
    }
    #generateContentModal .modal-content, #bulkGenerateModal .modal-content {
      background:#fff; padding:30px; border-radius:8px; min-width:360px; max-width:92vw;
      box-shadow:0 10px 30px rgba(0,0,0,.20);
    }
    #generateContentModal label, #bulkGenerateModal label { display:block; margin-top:10px; }
    #generateContentModal input, #generateContentModal select,
    #bulkGenerateModal input, #bulkGenerateModal select { width:100%; margin-top:6px; }
    .modal-actions { margin-top:20px; text-align:right; }
    .spinner {
      border: 6px solid #f3f3f3; border-top: 6px solid #0b5fff; border-radius: 50%;
      width: 44px; height: 44px; animation: spin 1s linear infinite; display:inline-block;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ---------- Overlay loader/thanks (unified for both flows) ---------- */
    .wpai-modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.45);
      display: none; align-items: center; justify-content: center; z-index: 10000;
    }
    .wpai-modal {
      width: 440px; max-width: 92vw; background: #fff; border-radius: 12px;
      padding: 24px 22px; box-shadow: 0 18px 40px rgba(0,0,0,.28);
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .wpai-modal h3 { margin: 0 0 10px; font-size: 18px; text-align:center; }
    .wpai-center { text-align: center; }
    .wpai-muted { color: #666; }
    .wpai-hidden { display:none; }
    .wpai-btn { display:inline-block; padding:8px 14px; border-radius:8px; border:1px solid #d0d0d0; background:#f7f7f7; cursor:pointer; }
  </style>
{% endblock %}

{% block content %}
{{ block.super }}

<!-- ========== SINGLE GENERATE MODAL ========== -->
<div id="generateContentModal">
  <div class="modal-content">
    <h3>Generate Post</h3>
    <form id="generateContentForm">
      <input type="hidden" id="single-keyword-id" name="keyword_id" />

      <label for="prompt_id">Select Prompt:</label>
      <select name="prompt_id" id="prompt_id">
        <option value="">Select…</option>
        {% for prompt in prompts %}
          <option value="{{ prompt.prompt_id }}">{{ prompt.prompt_id }}</option>
        {% endfor %}
      </select>

      <label for="prompt_type">Select Prompt type:</label>
      <select name="prompt_type" id="prompt_type">
        <option value="individual">Individual Prompt</option>
        <option value="master">Master Prompt</option>
      </select>

      <!-- NEW: Template chooser -->
      <label for="template_type">Choose Template:</label>
      <select name="template_type" id="template_type">
        <option value="regular" selected>Regular</option>
        <option value="modular">Modular</option>
      </select>

      <!-- NEW: Session + Year (only visible for Modular) -->
      <div id="sessionYearGroup" style="display:none; margin-top: 8px;">
        <label for="session">Session:</label>
        <select name="season" id="session">
          <option value="">Select session…</option>
          <option value="Spring">Spring</option>
          <option value="Summer">Summer</option>
          <option value="Fall">Fall</option>
          <option value="Winter">Winter</option>
        </select>

        <label for="year">Year:</label>
        <select name="year" id="year">
          <!-- Populated by JS -->
        </select>
      </div>

      <label for="modal-version-count">Number of Style Revisions:</label>
      <input type="number" id="modal-version-count" name="version_count" min="1" value="10" required />

      <div class="modal-actions">
        <button type="button" id="gen-cancel-btn">Cancel</button>
        <button type="submit" id="gen-confirm-btn">Generate</button>
      </div>
    </form>
  </div>
</div>

<script>
  (function () {
    const templateSelect = document.getElementById('template_type');
    const group = document.getElementById('sessionYearGroup');
    const session = document.getElementById('session');
    const year = document.getElementById('year');

    // Populate year options: current year ± 2
    const now = new Date();
    const currentYear = now.getFullYear();
    const years = [];
    for (let y = currentYear - 2; y <= currentYear + 2; y++) years.push(y);
    year.innerHTML = '<option value="">Select year…</option>' + years.map(y =>
      `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`
    ).join('');

    function toggleSessionYear() {
      const isModular = templateSelect.value === 'modular';
      group.style.display = isModular ? 'block' : 'none';

      // Make fields required only when visible
      session.required = isModular;
      year.required = isModular;
    }

    templateSelect.addEventListener('change', toggleSessionYear);
    // Initialize on load
    toggleSessionYear();
  })();
</script>

<!-- ========== BULK GENERATE MODAL ========== -->
<div id="bulkGenerateModal">
  <div class="modal-content">
    <h3>Generate Post (Bulk)</h3>
    <form id="bulkGenerateForm">
      <label for="bulk_prompt_id">Select Prompt:</label>
      <select name="prompt_id" id="bulk_prompt_id">
        <option value="">Select…</option>
        {% for prompt in prompts %}
          <option value="{{ prompt.prompt_id }}">{{ prompt.prompt_id }}</option>
        {% endfor %}
      </select>

      <label for="bulk_prompt_type">Select Prompt type:</label>
      <select name="prompt_type" id="bulk_prompt_type">
        <option value="individual">Individual Prompt</option>
        <option value="master">Master Prompt</option>
      </select>

      <!-- NEW: Template chooser -->
      <label for="bulk_template_type">Choose Template:</label>
      <select name="template_type" id="bulk_template_type">
        <option value="regular" selected>Regular</option>
        <option value="modular">Modular</option>
      </select>

      <!-- NEW: Season + Year (only visible for Modular) -->
      <div id="bulkSessionYearGroup" style="display:none; margin-top: 8px;">
        <label for="bulk_session">Season:</label>
        <select name="season" id="bulk_session">
          <option value="">Select season…</option>
          <option value="Spring">Spring</option>
          <option value="Summer">Summer</option>
          <option value="Fall">Fall</option>
          <option value="Winter">Winter</option>
        </select>

        <label for="bulk_year">Year:</label>
        <select name="year" id="bulk_year"></select>
      </div>

      <label for="bulk-version-count">Number of Style Revisions:</label>
      <input type="number" id="bulk-version-count" name="version_count" min="1" value="10" required />

      <div class="modal-actions">
        <button type="button" id="bulk-cancel">Cancel</button>
        <button type="submit" id="bulk-generate">Generate</button>
      </div>
    </form>
  </div>
</div>

<script>
  (function () {
    const templateSelect = document.getElementById('bulk_template_type');
    const group = document.getElementById('bulkSessionYearGroup');
    const season = document.getElementById('bulk_session');
    const year = document.getElementById('bulk_year');

    // Populate year options: current year ± 2
    const now = new Date();
    const currentYear = now.getFullYear();
    const years = [];
    for (let y = currentYear - 2; y <= currentYear + 2; y++) years.push(y);
    year.innerHTML = '<option value="">Select year…</option>' + years.map(y =>
      `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`
    ).join('');

    function toggleSessionYear() {
      const isModular = templateSelect.value === 'modular';
      group.style.display = isModular ? 'block' : 'none';
      season.required = isModular;
      year.required = isModular;
    }

    templateSelect.addEventListener('change', toggleSessionYear);
    toggleSessionYear(); // Initialize on load
  })();
</script>

<!-- ========== UNIFIED 5s LOADER + THANK-YOU OVERLAY ========== -->
<div id="wpaiEnqueueOverlay" class="wpai-modal-overlay">
  <div class="wpai-modal">
    <!-- Loading -->
    <div id="wpaiStateLoading">
      <h3>Submitting your request…</h3>
      <div class="wpai-center" style="margin:14px 0;"><div class="spinner"></div></div>
      <p class="wpai-center wpai-muted">This will take only a moment.</p>
    </div>
    <!-- Done -->
    <div id="wpaiStateDone" class="wpai-hidden">
      <h3>Thank you!</h3>
      <p class="wpai-center">
        We’re running your request in the background.<br/>
        Please refresh this page after a few seconds to see updates.
      </p>
      <p id="wpaiTime" class="wpai-center wpai-muted" style="margin-top:6px;"></p>
      <div class="wpai-center" style="margin-top:12px;">
        <button type="button" class="wpai-btn" id="wpaiCloseBtn">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- Utilities ---------- */
(function(){
  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? decodeURIComponent(m.pop()) : '';
  }
  const CSRF = getCookie('csrftoken');

  const OVERLAY = () => document.getElementById('wpaiEnqueueOverlay');
  const STATE_LOADING = () => document.getElementById('wpaiStateLoading');
  const STATE_DONE = () => document.getElementById('wpaiStateDone');
  const TIME_EL = () => document.getElementById('wpaiTime');

  function openOverlay() {
    OVERLAY().style.display = 'flex';
    STATE_LOADING().classList.remove('wpai-hidden');
    STATE_DONE().classList.add('wpai-hidden');
  }
  function showThanks(serverMsg) {
    const now = new Date();
    TIME_EL().textContent = 'Queued at ' + now.toLocaleString();
    STATE_LOADING().classList.add('wpai-hidden');
    STATE_DONE().classList.remove('wpai-hidden');
  }
  function closeOverlay() { OVERLAY().style.display = 'none'; }

  document.getElementById('wpaiCloseBtn')?.addEventListener('click', closeOverlay);

  async function postJSON(url, payload) {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF, 'Accept':'application/json' },
      body: JSON.stringify(payload)
    });
    let data = {};
    try { data = await res.json(); } catch(_){}
    return { ok: res.ok, status: res.status, data };
  }

  async function withFiveSecondLoader(doRequest) {
    openOverlay();
    const start = Date.now();
    let result;
    try {
      result = await doRequest();
    } catch (e) {
      result = { ok:false, data:{ message: 'Network error: ' + e } };
    }
    const elapsed = Date.now() - start;
    const wait = Math.max(0, 5000 - elapsed); // ensure a full 5 seconds
    await new Promise(r => setTimeout(r, wait));
    showThanks(result?.data?.message);
    // Optional auto-refresh after a short pause
    setTimeout(function(){ location.reload(); }, 6500);
  }

  /* ---------- Bulk flow wiring ---------- */
  const bulkModal  = document.getElementById('bulkGenerateModal');
  const bulkForm   = document.getElementById('bulkGenerateForm');
  function openBulk(){ bulkModal.style.display = 'flex'; }
  function closeBulk(){ bulkModal.style.display = 'none'; }
  document.getElementById('bulk-cancel')?.addEventListener('click', closeBulk);

  function selectedKeywordIds(){
    return Array.from(document.querySelectorAll('input.action-select:checked')).map(cb => cb.value);
  }

  const actionForm   = document.getElementById('changelist-form');
  const actionSelect = document.querySelector('select[name="action"]');
  if (actionForm) {
    actionForm.addEventListener('submit', function(e){
      const chosen = actionSelect ? actionSelect.value : null;
      if (chosen === 'generate_content_for_selected') {
        e.preventDefault();
        const ids = selectedKeywordIds();
        if (!ids.length) { alert('Please select at least one keyword.'); return; }
        openBulk();
      }
    });
  }

  bulkForm.addEventListener('submit', function(e){
  e.preventDefault();
  const ids = selectedKeywordIds();
  if (!ids.length) { alert('Please select at least one keyword.'); return; }

  const templateType = document.getElementById('bulk_template_type').value;
  const seasonEl = document.getElementById('bulk_session');
  const yearEl   = document.getElementById('bulk_year');

  // If Modular is chosen, enforce Season + Year
  if (templateType === 'modular') {
    if (!seasonEl.value || !yearEl.value) {
      alert('Please choose a season and year for Modular.');
      return;
    }
  }

  const payload = {
    keyword_ids: ids,
    prompt_id: document.getElementById('bulk_prompt_id').value,
    prompt_type: document.getElementById('bulk_prompt_type').value,
    version_count: parseInt(document.getElementById('bulk-version-count').value || '1', 10),

    // NEW:
    template_type: templateType,
    season: templateType === 'modular' ? seasonEl.value : '',
    year:   templateType === 'modular' ? parseInt(yearEl.value, 10) : ''
  };

  closeBulk();
  withFiveSecondLoader(() =>
    postJSON("{% url 'admin:ajax_bulk_generate' %}", payload)
  );
});

  /* ---------- Single flow wiring ---------- */
  const singleModal  = document.getElementById('generateContentModal');
  const singleForm   = document.getElementById('generateContentForm');
  const singleIdHid  = document.getElementById('single-keyword-id');
  function openSingle(id){ singleIdHid.value = id; singleModal.style.display = 'flex'; }
  function closeSingle(){ singleModal.style.display = 'none'; singleIdHid.value = ''; }
  document.getElementById('gen-cancel-btn')?.addEventListener('click', closeSingle);

  // Open modal when clicking "Generate Content" link in the table
  document.addEventListener('click', function(e){
    const a = e.target.closest('a');
    if (!a) return;
    if ((a.textContent || '').trim().toLowerCase() !== 'generate content') return;

    // Try to find the row's id
    let id = a.dataset.keywordId || null;
    if (!id) {
      const tr = a.closest('tr');
      const cb = tr && tr.querySelector('input.action-select');
      if (cb) id = cb.value;
    }
    if (!id) return;

    e.preventDefault();
    openSingle(id);
  });

  singleForm.addEventListener('submit', function(e){
  e.preventDefault();
  const kid = singleIdHid.value;
  if (!kid) { alert('Missing keyword id'); return; }

  const templateType = document.getElementById('template_type').value;
  const seasonEl = document.getElementById('session'); // id="session", name="season"
  const yearEl   = document.getElementById('year');

  if (templateType === 'modular') {
    if (!seasonEl.value || !yearEl.value) {
      alert('Please choose a season and year for Modular.');
      return;
    }
  }

  const payload = {
    keyword_id: kid,
    prompt_id: document.getElementById('prompt_id').value,
    prompt_type: document.getElementById('prompt_type').value,
    version_count: parseInt(document.getElementById('modal-version-count').value || '1', 10),

    // NEW:
    template_type: templateType,
    season: templateType === 'modular' ? seasonEl.value : '',
    year:   templateType === 'modular' ? parseInt(yearEl.value, 10) : ''
  };

  closeSingle();
  withFiveSecondLoader(() =>
    postJSON("{% url 'admin:ajax_generate_versions' %}", payload)
  );
 });

})();
</script>
{% endblock %}
