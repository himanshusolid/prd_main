{% extends "admin/change_list.html" %}

{% block object-tools-items %}
  <li><a href="upload-csv/" class="addlink">Upload CSV</a></li>
  {{ block.super }}
{% endblock %}

{% block extrahead %}
  {{ block.super }}
  <style>
   #generateContentModal {
    display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.4); align-items: center; justify-content: center;
}
#generateContentModal .modal-content {
    background: #fff; padding: 30px; border-radius: 8px; min-width: 350px; max-width: 90vw;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}
#generateContentModal label { display: block; margin-top: 10px; }
#generateContentModal input, #generateContentModal select { width: 100%; margin-top: 5px; }
#generateContentModal .modal-actions { margin-top: 20px; text-align: right; }
.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #3498db;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  display: inline-block;
}
@keyframes spin {
  0% { transform: rotate(0deg);}
  100% { transform: rotate(360deg);}
}
/* make the BULK modal look the same as the single modal */
#bulkGenerateModal{
  display:none; position:fixed; z-index:9999; left:0; top:0;
  width:100vw; height:100vh; background:rgba(0,0,0,.4);
  align-items:center; justify-content:center;
}
#bulkGenerateModal .modal-content{
  background:#fff; padding:30px; border-radius:8px;
  min-width:350px; max-width:90vw; box-shadow:0 2px 10px rgba(0,0,0,.2);
}
#bulkGenerateModal label{ display:block; margin-top:10px; }
#bulkGenerateModal input, #bulkGenerateModal select{ width:100%; margin-top:5px; }
#bulkGenerateModal .modal-actions{ margin-top:20px; text-align:right; }

  </style>
{% endblock %}

{% block content %}
{{ block.super }}

<!-- SINGLE-ROW MODAL: restored hidden keyword_id -->
<div id="generateContentModal">
  <div class="modal-content">
    <h3>Generate Post</h3>
    <form id="generateContentForm">
      <input type="hidden" id="single-keyword-id" name="keyword_id" />  <!-- ✅ restored -->
      <label for="prompt_id">Select Prompt:</label>
      <select name="prompt_id" id="prompt_id">
        {% for prompt in prompts %}
          <option value="{{ prompt.prompt_id }}">{{ prompt.prompt_id }}</option>
        {% endfor %}
      </select>

      <label for="prompt_type">Select Prompt type:</label>
      <select name="prompt_type" id="prompt_type">
        <option value="individual">individual Prompt</option>
        <option value="master">Master Prompt</option>
      </select>

      <label for="modal-version-count">Number of style Revisions:</label>
      <input type="number" id="modal-version-count" name="version_count" min="1" value="10" required />

      <div class="modal-actions">
        <button type="button" id="gen-cancel-btn">Cancel</button>
        <button type="submit" id="gen-confirm-btn">Generate</button>
      </div>
    </form>
    <div id="generate-loader" style="display:none;text-align:center;margin-top:20px;">
      <div class="spinner" style="margin:auto;"></div>
      <div style="margin-top:10px;">Generating versions, please wait...</div>
    </div>
  </div>
</div>

<!-- BULK MODAL (unchanged) -->
<div id="bulkGenerateModal" style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,.4);align-items:center;justify-content:center;">
  <div class="modal-content">
    <h3>Generate Post (Bulk)</h3>
    <form id="bulkGenerateForm">
      <label for="bulk_prompt_id">Select Prompt:</label>
      <select name="prompt_id" id="bulk_prompt_id">
        {% for prompt in prompts %}
          <option value="{{ prompt.prompt_id }}">{{ prompt.prompt_id }}</option>
        {% endfor %}
      </select>
      <label for="bulk_prompt_type">Select Prompt type:</label>
      <select name="prompt_type" id="bulk_prompt_type">
        <option value="individual">individual Prompt</option>
        <option value="master">Master Prompt</option>
      </select>
      <label for="bulk-version-count">Number of style Revisions:</label>
      <input type="number" id="bulk-version-count" name="version_count" min="1" value="10" required />
      <div class="modal-actions">
        <button type="button" id="bulk-cancel">Cancel</button>
        <button type="submit" id="bulk-generate">Generate</button>
      </div>
    </form>
    <div id="bulk-loader" style="display:none;text-align:center;margin-top:20px;">
      <div class="spinner" style="margin:auto;"></div>
      <div style="margin-top:10px;">Starting bulk generation…</div>
    </div>
  </div>
</div>

<script>
/* ===== BULK ACTION ONLY ===== */
(function(){
  const bulkModal  = document.getElementById('bulkGenerateModal');
  const bulkForm   = document.getElementById('bulkGenerateForm');
  const bulkLoader = document.getElementById('bulk-loader');

  function openBulk(){ bulkModal.style.display = 'flex'; }
  function closeBulk(){ bulkModal.style.display = 'none'; }
  document.getElementById('bulk-cancel')?.addEventListener('click', closeBulk);

  function getSelectedIds(){
    return Array.from(document.querySelectorAll('input.action-select:checked')).map(cb => cb.value);
  }

  // Intercept admin action submit -> show BULK modal
  const actionForm   = document.getElementById('changelist-form');
  const actionSelect = document.querySelector('select[name="action"]');

  if (actionForm) {
    actionForm.addEventListener('submit', function(e){
      const chosen = actionSelect ? actionSelect.value : null;
      if (chosen === 'generate_content_for_selected') {
        e.preventDefault();
        const ids = getSelectedIds();
        if (!ids.length) { alert('Please select at least one keyword.'); return; }
        openBulk();
      }
    });
  }

  // Submit BULK to new endpoint
  bulkForm.addEventListener('submit', async function(e){
    e.preventDefault();
    const ids = Array.from(document.querySelectorAll('input.action-select:checked')).map(cb => cb.value);
    if (!ids.length) { alert('Please select at least one keyword.'); return; }

    const payload = {
      keyword_ids: ids,
      prompt_id: document.getElementById('bulk_prompt_id').value,
      prompt_type: document.getElementById('bulk_prompt_type').value,
      version_count: document.getElementById('bulk-version-count').value || 1
    };

    bulkLoader.style.display = 'block';
    Array.from(bulkForm.elements).forEach(el => el.disabled = true);

    try{
      const res = await fetch("{% url 'admin:ajax_bulk_generate' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value
        },
        body: JSON.stringify(payload)
      });
      const data = await res.json();

      bulkLoader.style.display = 'none';
      Array.from(bulkForm.elements).forEach(el => el.disabled = false);

      if (res.ok && data.success){
        alert(data.message || 'Bulk generation queued.');
        closeBulk();
        window.location.reload();
      } else {
        alert(data.message || 'Failed to start bulk generation.');
      }
    }catch(err){
      bulkLoader.style.display = 'none';
      Array.from(bulkForm.elements).forEach(el => el.disabled = false);
      alert('Network error: ' + err);
    }
  });
})();
</script>

<script>
/* ===== SINGLE-ROW BUTTON ONLY ===== */
(function(){
  const modal  = document.getElementById('generateContentModal');
  const form   = document.getElementById('generateContentForm');
  const loader = document.getElementById('generate-loader');
  const hidId  = document.getElementById('single-keyword-id');

  function openSingle(id){ hidId.value = id; modal.style.display = 'flex'; }
  function closeSingle(){ modal.style.display = 'none'; hidId.value = ''; }
  document.getElementById('gen-cancel-btn')?.addEventListener('click', closeSingle);

  // Robust event delegation for row buttons labeled "Generate Content"
  document.addEventListener('click', function(e){
    const a = e.target.closest('a');
    if (!a) return;
    const label = (a.textContent || '').trim().toLowerCase();
    if (label !== 'generate content') return;

    // Extract ID from data attribute OR from href pattern OR from the row checkbox
    let id = a.dataset.keywordId || null;
    if (!id) {
      const href = a.getAttribute('href') || '';
      let m = href.match(/\/generate-content\/(\d+)\/?$/i);  // if your link goes to generate view
      if (m) id = m[1];
      if (!id) { m = href.match(/(\d+)\/?$/); if (m) id = m[1]; }
    }
    if (!id) {
      const tr = a.closest('tr');
      const cb = tr && tr.querySelector('input.action-select');
      if (cb) id = cb.value;
    }
    if (!id) return;  // not our button

    e.preventDefault();
    openSingle(id);
  });

  // Submit SINGLE to your existing endpoint
  form.addEventListener('submit', async function(e){
    e.preventDefault();
    const id = hidId.value;
    if (!id) { alert('Missing keyword id'); return; }

    const fd = new FormData(form);
    fd.set('keyword_id', id); // ensure present

    loader.style.display = 'block';
    Array.from(form.elements).forEach(el => el.disabled = true);

    try{
      const res = await fetch('/admin/WordAI_Publisher/keyword/ajax-generate-versions/', {
        method: 'POST',
        headers: { 'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value },
        body: fd
      });
      const data = await res.json();

      loader.style.display = 'none';
      Array.from(form.elements).forEach(el => el.disabled = false);

      if (res.ok && data.success){
        alert(data.message || 'Generation started.');
        closeSingle();
        window.location.reload();
      } else {
        alert(data.message || 'Failed to start generation.');
      }
    }catch(err){
      loader.style.display = 'none';
      Array.from(form.elements).forEach(el => el.disabled = false);
      alert('Network error: ' + err);
    }
  });
})();
</script>
{% endblock %}
