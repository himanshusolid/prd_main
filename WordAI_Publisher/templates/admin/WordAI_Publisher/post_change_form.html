{% extends "admin/change_form.html" %}
{% load static %}
{% load custom_filters %}

{% block extrahead %}
{{ block.super }}
<script src="{% static 'WordAI_Publisher/js/regen_buttons.js' %}"></script>
{% endblock %}

{% block content %}
{{ block.super }}
<style>
#id_generated_title, #id_meta_title {
    width: 950px !important;
    height: 44px !important;
    resize: none;
}
#id_meta_description {
    width: 951px !important;
    height: 85px !important;
    resize: none;
}
.regen-btn {
    display: inline-block;
    margin-left: 8px;
    padding: 12px 27px;
    background: #f5f5f5;
    border: 1px solid #79aec8;
    border-radius: 4px;
    color: #333;
    font-size: 13px;
    cursor: pointer;
    vertical-align: middle;
    float: inline-end;
}
#fullPageLoader {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.8);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    font-weight: bold;
    color: #333;
    display: none;
}
.form-row.field-featured_prompt_text,
.form-row.field-style_prompts,.form-row.field-style_image_descriptions {
    display: none;
}

/* ---- Card used beside each section field ---- */
.section-card {
  border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #fff;
  margin: 10px 0 18px;     max-width: 297px;
  
}
.section-card img {
  max-width: 195px;
    max-height: 150px;
    border: 1px solid #ccc;
    border-radius: 8px;
    margin-bottom: 6px;
  
}
.section-card .title {
  font-size: 13px; font-weight: 600; margin: 6px 0 8px;
}
.section-card .btn-row button {
  margin-top: 6px; padding: 6px 10px; font-size: 12px; border-radius: 4px; cursor: pointer;
}
.section-card .btn-row .regen {
  border: 1px solid #79aec8; background: #f5f5f5;
}
.section-card .btn-row .view {
  border: 1px solid #79aec8; background: #eef6fc; margin-left: 6px;
}
</style>

<script>
window.addEventListener('DOMContentLoaded', function () {
    // Keep your existing repositioning for Featured + Style blocks
    const styleImagesSection = document.querySelector('[data-style-images-section]');
    const styleSectionField = document.querySelector('#id_generated_style_section');
    if (styleImagesSection && styleSectionField) {
        const parentRow = styleSectionField.closest('.form-row, .form-group');
        if (parentRow && parentRow.nextSibling) {
            parentRow.parentNode.insertBefore(styleImagesSection, parentRow.nextSibling);
        } else if (parentRow) {
            parentRow.parentNode.appendChild(styleImagesSection);
        }
    }

    const featuredImageSection = document.querySelector('[data-featured-image-section]');
    const featuredImageField = document.querySelector('#id_featured_image');
    if (featuredImageSection && featuredImageField) {
        const parentRow = featuredImageField.closest('.form-row, .form-group');
        if (parentRow && parentRow.nextSibling) {
            parentRow.parentNode.insertBefore(featuredImageSection, parentRow.nextSibling);
        } else if (parentRow) {
            parentRow.parentNode.appendChild(featuredImageSection);
        }
    }

    // NEW: move each section image card right after its own field
    document.querySelectorAll('#section-cards-staging [data-section-card]').forEach(card => {
        const anchorSel = card.getAttribute('data-anchor'); // e.g. "#id_generated_quick_style_snapshot"
        const anchor = document.querySelector(anchorSel);
        if (!anchor) return;
        const row = anchor.closest('.form-row, .form-group');
        if (!row) return;
        row.insertAdjacentElement('afterend', card);
        card.style.display = ''; // unhide
    });
});
</script>

<!-- ========= FEATURED IMAGE SECTION ========== -->
<div data-featured-image-section>
  {% if original.featured_image %}
  <div style="margin: 18px 0 10px 0;">
    <label><strong>Featured Image Preview:</strong></label><br>
    {% if original.featured_image_status == 'in_process' %}
      <img src="/static/WordAI_Publisher/img/placeholder.png" alt="Generating..." style="max-width: 300px; max-height: 200px; border: 1px solid #ccc; border-radius: 8px; margin-top: 6px;" />
    {% else %}
      <img src="{{ original.featured_image.url }}" alt="Featured Image" style="max-width: 300px; max-height: 200px; border: 1px solid #ccc; border-radius: 8px; margin-top: 6px;" />
    {% endif %}
  </div>

  <div style="margin-top: 10px;">
    <button type="button" id="regen-featured-btn" style="margin-left: 8px; padding: 12px 27px; background: #f5f5f5; border: 1px solid #79aec8; border-radius: 4px; color: #333; font-size: 13px; cursor: pointer;">
      🔄 Regenerate Featured Image
    </button>
    <button type="button" onclick="showPromptPopup('Featured Image Prompt', '{{ original.featured_prompt_text|escapejs }}', 'featured_image')" style="margin-left: 10px; padding: 12px 20px; background: #eef6fc; border: 1px solid #79aec8; border-radius: 4px; font-size: 13px; cursor: pointer;">
      🔍 View Prompt
    </button>
  </div>
  {% endif %}
</div>

<!-- ========= STYLE IMAGES SECTION (unchanged) ========== -->
<div data-style-images-section>
  {% if original.style_images %}
    <div style="margin-top: 30px;">
      <label><strong>Style Images:</strong></label>
      <div style="display: flex; flex-wrap: wrap; gap: 16px;">
        {% for style, url in original.style_images.items %}
          {% if url %}
            <div style="text-align: center;">
              <a href="{{ url }}" target="_blank">
                <img src="{{ url }}" alt="{{ style }}" style="max-width: 120px; max-height: 120px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 6px;" />
              </a>
              <div style="font-size: 13px; margin-top: 2px;">{{ style }}</div>
              <button type="button" class="regen-style-single-btn" data-style-name="{{ style }}" style="margin-top: 6px; padding: 6px 12px; font-size: 12px; border: 1px solid #79aec8; background: #f5f5f5; border-radius: 4px; cursor: pointer;">
                🔄 Regenerate Image
              </button>
              {% if original.style_prompts and style in original.style_prompts %}
              <button type="button"
                      onclick="showPromptPopup('Prompt for {{ style }}', '{{ original.style_prompts|get_item:style|escapejs }}', '{{ style }}')"
                      style="margin-top: 6px; padding: 6px 12px; font-size: 12px; border: 1px solid #79aec8; background: #eef6fc; border-radius: 4px; cursor: pointer;">
                🔍 View Prompt
              </button>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  {% endif %}
</div>

<!-- ========= NEW: STAGING AREA FOR PER-SECTION CARDS ========= -->
<!-- These are hidden initially; JS moves each card after its field -->
<div id="section-cards-staging" style="display:none;">
  <!-- Quick Style Snapshot -->
  <div class="section-card" data-section-card="generated_quick_style_snapshot_image" data-anchor="#id_generated_quick_style_snapshot">
    <div class="title">Quick Style Snapshot</div>
    {% if original.generated_quick_style_snapshot_image %}
      <a href="{{ original.generated_quick_style_snapshot_image }}" target="_blank">
        <img src="{{ original.generated_quick_style_snapshot_image }}" alt="Quick Style Snapshot" />
      </a>
    {% else %}
      <img src="/static/WordAI_Publisher/img/placeholder.png" alt="No image yet" />
    {% endif %}
    <div class="btn-row">
      <!-- <button type="button" class="regen regen-section-image-btn" data-section-field="generated_quick_style_snapshot_image">🔄 Regenerate Image</button> -->
      <button type="button" class="view" onclick="showReadOnlyPrompt('Prompt: Quick Style Snapshot', '{{ original.prompt.quick_style_snapshot_image_prompt|default_if_none:''|escapejs }}')">🔍 View Prompt</button>
    </div>
  </div>

  <!-- Packing Essentials -->
  <div class="section-card" data-section-card="generated_packing_essentials_checklist_image" data-anchor="#id_generated_packing_essentials_checklist">
    <div class="title">Packing Essentials</div>
    {% if original.generated_packing_essentials_checklist_image %}
      <a href="{{ original.generated_packing_essentials_checklist_image }}" target="_blank">
        <img src="{{ original.generated_packing_essentials_checklist_image }}" alt="Packing Essentials" />
      </a>
    {% else %}
      <img src="/static/WordAI_Publisher/img/placeholder.png" alt="No image yet" />
    {% endif %}
    <div class="btn-row">
      <!-- <button type="button" class="regen regen-section-image-btn" data-section-field="generated_packing_essentials_checklist_image">🔄 Regenerate Image</button> -->
      <button type="button" class="view" onclick="showReadOnlyPrompt('Prompt: Packing Essentials', '{{ original.prompt.packing_essentials_checklist_image_prompt|default_if_none:''|escapejs }}')">🔍 View Prompt</button>
    </div>
  </div>

  <!-- Daytime Outfits -->
  <div class="section-card" data-section-card="generated_daytime_outfits_image" data-anchor="#id_generated_daytime_outfits">
    <div class="title">Daytime Outfits</div>
    {% if original.generated_daytime_outfits_image %}
      <a href="{{ original.generated_daytime_outfits_image }}" target="_blank">
        <img src="{{ original.generated_daytime_outfits_image }}" alt="Daytime Outfits" />
      </a>
    {% else %}
      <img src="/static/WordAI_Publisher/img/placeholder.png" alt="No image yet" />
    {% endif %}
    <div class="btn-row">
      <!-- <button type="button" class="regen regen-section-image-btn" data-section-field="generated_daytime_outfits_image">🔄 Regenerate Image</button> -->
      <button type="button" class="view" onclick="showReadOnlyPrompt('Prompt: Daytime Outfits', '{{ original.prompt.daytime_outfits_image_prompt|default_if_none:''|escapejs }}')">🔍 View Prompt</button>
    </div>
  </div>

  <!-- Evening & Nightlife -->
  <div class="section-card" data-section-card="generated_evening_and_nightlife_image" data-anchor="#id_generated_evening_and_nightlife">
    <div class="title">Evening & Nightlife</div>
    {% if original.generated_evening_and_nightlife_image %}
      <a href="{{ original.generated_evening_and_nightlife_image }}" target="_blank">
        <img src="{{ original.generated_evening_and_nightlife_image }}" alt="Evening & Nightlife" />
      </a>
    {% else %}
      <img src="/static/WordAI_Publisher/img/placeholder.png" alt="No image yet" />
    {% endif %}
    <div class="btn-row">
      <!-- <button type="button" class="regen regen-section-image-btn" data-section-field="generated_evening_and_nightlife_image">🔄 Regenerate Image</button> -->
      <button type="button" class="view" onclick="showReadOnlyPrompt('Prompt: Evening & Nightlife', '{{ original.prompt.evening_and_nightlife_image_prompt|default_if_none:''|escapejs }}')">🔍 View Prompt</button>
    </div>
  </div>

  <!-- Outdoor Activities -->
  <div class="section-card" data-section-card="generated_outdoor_activities_image" data-anchor="#id_generated_outdoor_activities">
    <div class="title">Outdoor Activities</div>
    {% if original.generated_outdoor_activities_image %}
      <a href="{{ original.generated_outdoor_activities_image }}" target="_blank">
        <img src="{{ original.generated_outdoor_activities_image }}" alt="Outdoor Activities" />
      </a>
    {% else %}
      <img src="/static/WordAI_Publisher/img/placeholder.png" alt="No image yet" />
    {% endif %}
    <div class="btn-row">
      <!-- <button type="button" class="regen regen-section-image-btn" data-section-field="generated_outdoor_activities_image">🔄 Regenerate Image</button> -->
      <button type="button" class="view" onclick="showReadOnlyPrompt('Prompt: Outdoor Activities', '{{ original.prompt.outdoor_activities_image_prompt|default_if_none:''|escapejs }}')">🔍 View Prompt</button>
    </div>
  </div>

  <!-- Seasonal Variations -->
  <div class="section-card" data-section-card="generated_seasonal_variations_image" data-anchor="#id_generated_seasonal_variations">
    <div class="title">Seasonal Variations</div>
    {% if original.generated_seasonal_variations_image %}
      <a href="{{ original.generated_seasonal_variations_image }}" target="_blank">
        <img src="{{ original.generated_seasonal_variations_image }}" alt="Seasonal Variations" />
      </a>
    {% else %}
      <img src="/static/WordAI_Publisher/img/placeholder.png" alt="No image yet" />
    {% endif %}
    <div class="btn-row">
      <!-- <button type="button" class="regen regen-section-image-btn" data-section-field="generated_seasonal_variations_image">🔄 Regenerate Image</button> -->
      <button type="button" class="view" onclick="showReadOnlyPrompt('Prompt: Seasonal Variations', '{{ original.prompt.seasonal_variations_image_prompt|default_if_none:''|escapejs }}')">🔍 View Prompt</button>
    </div>
  </div>

  <!-- Style Tips for Blending -->
  <div class="section-card" data-section-card="generated_style_tips_for_blending_image" data-anchor="#id_generated_style_tips_for_blending">
    <div class="title">Style Tips for Blending</div>
    {% if original.generated_style_tips_for_blending_image %}
      <a href="{{ original.generated_style_tips_for_blending_image }}" target="_blank">
        <img src="{{ original.generated_style_tips_for_blending_image }}" alt="Style Tips for Blending" />
      </a>
    {% else %}
      <img src="/static/WordAI_Publisher/img/placeholder.png" alt="No image yet" />
    {% endif %}
    <div class="btn-row">
      <!-- <button type="button" class="regen regen-section-image-btn" data-section-field="generated_style_tips_for_blending_image">🔄 Regenerate Image</button> -->
      <button type="button" class="view" onclick="showReadOnlyPrompt('Prompt: Style Tips for Blending', '{{ original.prompt.style_tips_for_blending_image_prompt|default_if_none:''|escapejs }}')">🔍 View Prompt</button>
    </div>
  </div>

  <!-- Destination-Specific Extras -->
  <div class="section-card" data-section-card="generated_destination_specific_extras_image" data-anchor="#id_generated_destination_specific_extras">
    <div class="title">Destination-Specific Extras</div>
    {% if original.generated_destination_specific_extras_image %}
      <a href="{{ original.generated_destination_specific_extras_image }}" target="_blank">
        <img src="{{ original.generated_destination_specific_extras_image }}" alt="Destination-Specific Extras" />
      </a>
    {% else %}
      <img src="/static/WordAI_Publisher/img/placeholder.png" alt="No image yet" />
    {% endif %}
    <div class="btn-row">
      <!-- <button type="button" class="regen regen-section-image-btn" data-section-field="generated_destination_specific_extras_image">🔄 Regenerate Image</button> -->
      <button type="button" class="view" onclick="showReadOnlyPrompt('Prompt: Destination-Specific Extras', '{{ original.prompt.destination_specific_extras_image_prompt|default_if_none:''|escapejs }}')">🔍 View Prompt</button>
    </div>
  </div>
</div>

<!-- ========= POPUP MODAL (shared) ========== -->
<div id="prompt-modal" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
     background: white; border: 1px solid #ccc; border-radius: 10px; padding: 20px; z-index: 9999; max-width: 600px; width: 90%;">
  <h3 id="prompt-title" style="margin-top: 0;"></h3>
  <textarea id="prompt-content" style="width: 100%; height: 180px; white-space: pre-wrap; font-family: monospace; background: #f9f9f9; padding: 10px; border-radius: 6px; border: 1px solid #ccc;"></textarea>
  <div style="margin-top: 12px;">
    <button id="prompt-save-btn" onclick="savePromptContent()" style="padding: 6px 14px; border: none; background: #4CAF50; color: white; border-radius: 4px; cursor: pointer;">💾 Save</button>
    <button onclick="closePromptPopup()" style="margin-left: 8px; padding: 6px 14px; border: none; background: #79aec8; color: white; border-radius: 4px; cursor: pointer;">Close</button>
  </div>
</div>
<div id="prompt-overlay" onclick="closePromptPopup()" style="display:none; position: fixed; top: 0; left: 0;
     width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 9998;"></div>

{% endblock %}

{% block after_field_sets %}
<script>
let currentPromptStyle = null;

function showPromptPopup(title, content, styleName = null) {
    document.getElementById('prompt-title').textContent = title;
    document.getElementById('prompt-content').value = content;
    currentPromptStyle = styleName;
    document.getElementById('prompt-save-btn').style.display = ''; // editable prompts
    document.getElementById('prompt-modal').style.display = 'block';
    document.getElementById('prompt-overlay').style.display = 'block';
}
function showReadOnlyPrompt(title, content) {
    document.getElementById('prompt-title').textContent = title;
    document.getElementById('prompt-content').value = content;
    currentPromptStyle = null;
    document.getElementById('prompt-save-btn').style.display = 'none'; // view only
    document.getElementById('prompt-modal').style.display = 'block';
    document.getElementById('prompt-overlay').style.display = 'block';
}
function closePromptPopup() {
    document.getElementById('prompt-modal').style.display = 'none';
    document.getElementById('prompt-overlay').style.display = 'none';
}
function savePromptContent() {
    const updatedContent = document.getElementById('prompt-content').value;
    if (!currentPromptStyle) {
        alert('This prompt is view-only here. Edit it on the Prompt object.');
        return;
    }
    fetch('/admin/WordAI_Publisher/keyword/save-style-prompt/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json','X-CSRFToken': getCSRFToken()},
        body: JSON.stringify({ style_name: currentPromptStyle, content: updatedContent, object_id: '{{ original.pk }}' })
    }).then(r => r.ok ? location.reload() : alert('Failed to save prompt.'));
}
function getCSRFToken() {
    const cookie = document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='));
    return cookie ? cookie.split('=')[1] : '';
}

/* TEXT regeneration (unchanged) */
async function regenerateSection(fieldName, buttonEl) {
  try {
    showLoader(true);
    if (buttonEl) { buttonEl.disabled = true; buttonEl.textContent = '⏳ Regenerating...'; }
    const resp = await fetch('/admin/WordAI_Publisher/keyword/ajax-regenerate-versions/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json','X-CSRFToken': getCSRFToken()},
      body: JSON.stringify({ post_id: '{{ original.pk }}', content_type: fieldName })
    });
    if (!resp.ok) throw new Error(await resp.text() || 'Failed to regenerate');
    const data = await resp.json();
    const html = data.content || '';
    const fieldId = 'id_' + fieldName;
    if (window.CKEDITOR && CKEDITOR.instances[fieldId]) CKEDITOR.instances[fieldId].setData(html);
    else { const t = document.getElementById(fieldId); if (t) t.value = html; }
  } catch (e) { alert('Regenerate error: ' + (e?.message || e)); }
  finally { if (buttonEl) { buttonEl.disabled = false; buttonEl.textContent = '🔄 Regenerate'; } showLoader(false); }
}

/* NEW: regenerate a single section image */
async function regenerateSectionImage(sectionField, buttonEl) {
  try {
    showLoader(true);
    if (buttonEl) { buttonEl.disabled = true; buttonEl.textContent = '⏳ Regenerating...'; }
    const resp = await fetch('/admin/WordAI_Publisher/keyword/regen-section-image/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json','X-CSRFToken': getCSRFToken()},
      body: JSON.stringify({ post_id: '{{ original.pk }}', section_field: sectionField })
    });
    if (!resp.ok) throw new Error(await resp.text() || 'Failed to regenerate section image');

    const data = await resp.json(); // { url: '...' }
    const card = document.querySelector(`.section-card[data-section-card="${sectionField}"]`);
    const img = card?.querySelector('img');
    if (img && data.url) {
      img.src = data.url + '?t=' + Date.now(); // cache-bust
      const link = card.querySelector('a');
      if (link) link.href = data.url;
    }
  } catch (e) { alert('Regenerate image error: ' + (e?.message || e)); }
  finally { if (buttonEl) { buttonEl.disabled = false; buttonEl.textContent = '🔄 Regenerate Image'; } showLoader(false); }
}

/* Place text regen buttons + bind image regen */
document.addEventListener('DOMContentLoaded', function () {
  const map = [
    { btn: '#regen-quick-style-snapshot-btn', field: 'generated_quick_style_snapshot' },
    { btn: '#regen-packing-essentials-btn',   field: 'generated_packing_essentials_checklist' },
    { btn: '#regen-daytime-outfits-btn',      field: 'generated_daytime_outfits' },
    { btn: '#regen-evening-nightlife-btn',    field: 'generated_evening_and_nightlife' },
    { btn: '#regen-outdoor-activities-btn',   field: 'generated_outdoor_activities' },
    { btn: '#regen-seasonal-variations-btn',  field: 'generated_seasonal_variations' },
    { btn: '#regen-style-tips-blending-btn',  field: 'generated_style_tips_for_blending' },
    { btn: '#regen-destination-extras-btn',   field: 'generated_destination_specific_extras' },
  ];
  map.forEach(({ btn, field }) => {
    const button = document.querySelector(btn);
    const row = document.querySelector(`[name="${field}"]`)?.closest('.form-row, .form-group');
    if (row && button) { row.appendChild(button); button.addEventListener('click', () => regenerateSection(field, button)); }
  });

  document.querySelectorAll('.regen-section-image-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const field = btn.getAttribute('data-section-field');
      regenerateSectionImage(field, btn);
    });
  });
});

/* Loader */
function showLoader(show) {
  const el = document.getElementById('fullPageLoader');
  if (el) el.style.display = show ? 'flex' : 'none';
}
</script>

<!-- Regenerate Buttons (TEXT) -->
<button type="button" id="regen-title-btn" class="regen-btn">🔄 Regenerate</button>
<button type="button" id="regen-intro-btn" class="regen-btn">🔄 Regenerate</button>
<button type="button" id="regen-style-btn" class="regen-btn">🔄 Regenerate</button>
<button type="button" id="regen-conclusion-btn" class="regen-btn">🔄 Regenerate</button>
<button type="button" id="regen-meta-title-btn" class="regen-btn">🔄 Regenerate</button>
<button type="button" id="regen-meta-description-btn" class="regen-btn">🔄 Regenerate</button>

<!-- Modular section text regenerate buttons -->
<button type="button" id="regen-quick-style-snapshot-btn" class="regen-btn" data-field="generated_quick_style_snapshot">🔄 Regenerate</button>
<button type="button" id="regen-packing-essentials-btn" class="regen-btn" data-field="generated_packing_essentials_checklist">🔄 Regenerate</button>
<button type="button" id="regen-daytime-outfits-btn" class="regen-btn" data-field="generated_daytime_outfits">🔄 Regenerate</button>
<button type="button" id="regen-evening-nightlife-btn" class="regen-btn" data-field="generated_evening_and_nightlife">🔄 Regenerate</button>
<button type="button" id="regen-outdoor-activities-btn" class="regen-btn" data-field="generated_outdoor_activities">🔄 Regenerate</button>
<button type="button" id="regen-seasonal-variations-btn" class="regen-btn" data-field="generated_seasonal_variations">🔄 Regenerate</button>
<button type="button" id="regen-style-tips-blending-btn" class="regen-btn" data-field="generated_style_tips_for_blending">🔄 Regenerate</button>
<button type="button" id="regen-destination-extras-btn" class="regen-btn" data-field="generated_destination_specific_extras">🔄 Regenerate</button>

<!-- Loader -->
<div id="fullPageLoader">
  ⏳ Generating, please wait...
</div>
{% endblock %}
